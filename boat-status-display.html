<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boat Status Display System v5 - Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            overflow-x: auto;
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            background: linear-gradient(45deg, #00bfff, #b19cd9);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Main Display Controls */
        .display-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            align-items: center;
        }

        .display-controls label {
            font-weight: bold;
            color: #00bfff;
        }

        .display-controls select {
            padding: 5px 10px;
            background: #333;
            border: 1px solid #555;
            color: #fff;
            border-radius: 3px;
            cursor: pointer;
        }

        .display-controls button {
            padding: 5px 15px;
            background: linear-gradient(45deg, #00bfff, #b19cd9);
            border: none;
            border-radius: 3px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .display-controls button:hover {
            transform: scale(1.05);
        }

        /* Main display area */
        .main-display {
            position: relative;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 10px;
            min-height: 600px;
            height: 600px;
            margin-bottom: 20px;
            overflow: hidden;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            cursor: default;
        }

        .main-display.draggable-area {
            cursor: crosshair;
        }

        /* Small status boxes */
        .status-boxes {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 20px;
        }

        .status-box {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 10px;
            min-width: 200px;
            max-width: 250px;
            flex: 1;
        }

        .status-box h3 {
            color: #00bfff;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-align: center;
        }

        .status-box-content {
            min-height: 80px;
            overflow: visible;
            position: relative;
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            padding: 5px;
        }

        /* Pod styles */
        .pod {
            display: inline-flex;
            flex-wrap: wrap;
            gap: 3px;
            padding: 3px;
            margin: 2px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px dashed #666;
            border-radius: 5px;
            position: relative;
        }

        .pod.selected {
            background: rgba(0, 191, 255, 0.2);
            border-color: #00bfff;
        }

        /* Legend with pods */
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 0.85em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Boat sizes */
        .legend-boat-wrapper {
            width: 16px;
            height: 32px;
            position: relative;
            padding: 2px;
            background: #fff;
            clip-path: polygon(50% 0%, 85% 15%, 95% 35%, 95% 65%, 85% 85%, 75% 100%, 25% 100%, 15% 85%, 5% 65%, 5% 35%, 15% 15%);
            display: inline-block;
        }

        .legend-boat-wrapper.user-leg {
            background: #b19cd9;
        }

        .legend-boat-wrapper.user-lat {
            background: #00bfff;
        }

        .legend-boat {
            width: 12px;
            height: 28px;
            position: relative;
            overflow: visible;
            clip-path: polygon(50% 0%, 85% 15%, 95% 35%, 95% 65%, 85% 85%, 75% 100%, 25% 100%, 15% 85%, 5% 65%, 5% 35%, 15% 15%);
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ff0000;
        }

        /* Status colors */
        .legend-boat.status-none { background-color: #ff0000 !important; }
        .legend-boat.status-platform { background-color: #ff8c00 !important; }
        .legend-boat.status-pierside { background-color: #ffff00 !important; }
        .legend-boat.status-pretow { 
            background: repeating-linear-gradient(
                45deg,
                #ffffff,
                #ffffff 2px,
                #00ff00 2px,
                #00ff00 4px
            ) !important;
        }
        .legend-boat.status-operational { background-color: #00ff00 !important; }

        /* User indicators */
        .legend-boat-wrapper .user-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 6px;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .legend-boat-wrapper.user-leg .user-indicator {
            background-color: #b19cd9;
        }

        .legend-boat-wrapper.user-lat .user-indicator {
            background-color: #00bfff;
        }

        /* Boat number with white background */
        .legend-boat .boat-number {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 1px 2px;
            border-radius: 2px;
            font-size: 8px;
            font-weight: bold;
            z-index: 2;
            white-space: nowrap;
        }

        /* Boat styles */
        .boat {
            position: absolute;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.3s ease;
            overflow: visible;
            clip-path: polygon(50% 0%, 85% 15%, 95% 35%, 95% 65%, 85% 85%, 75% 100%, 25% 100%, 15% 85%, 5% 65%, 5% 35%, 15% 15%);
            background-color: #ff0000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .boat:active {
            cursor: grabbing;
        }

        /* Boat wrapper for outline */
        .boat-wrapper {
            position: absolute;
            background: transparent;
            display: inline-block;
            cursor: grab;
        }

        .boat-wrapper:active {
            cursor: grabbing;
        }

        .boat-wrapper.in-small-box {
            position: relative !important;
            display: inline-block;
            margin: 2px;
        }

        .boat-outline {
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: #fff;
            clip-path: polygon(50% 0%, 85% 15%, 95% 35%, 95% 65%, 85% 85%, 75% 100%, 25% 100%, 15% 85%, 5% 65%, 5% 35%, 15% 15%);
            z-index: 0;
        }

        .boat-wrapper.user-leg .boat-outline {
            background: #b19cd9;
        }

        .boat-wrapper.user-lat .boat-outline {
            background: #00bfff;
        }

        /* Rotation handle */
        .rotation-handle {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 50%;
            cursor: grab;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            pointer-events: all;
        }

        .boat-wrapper:hover .rotation-handle {
            opacity: 1;
        }

        .rotation-handle:hover {
            background: #fff;
            transform: translateX(-50%) scale(1.2);
        }

        .rotation-handle:active {
            cursor: grabbing;
        }

        /* Hide rotation handles in small boxes */
        .boat-wrapper.in-small-box .rotation-handle {
            display: none;
        }

        /* Boat sizes */
        .boat-type-1 {
            width: 30px;
            height: 60px;
        }

        .boat-type-2 {
            width: 26px;
            height: 44px;
        }

        .boat:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .boat-wrapper.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }

        .boat-number {
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            padding: 2px 3px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            z-index: 2;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .boat-type-2 .boat-number {
            font-size: 9px;
            padding: 1px 2px;
        }

        .user-indicator {
            position: absolute;
            bottom: 3px;
            right: 3px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            z-index: 3;
        }

        /* Boat Status Colors */
        .status-none { background-color: #ff0000 !important; }
        .status-platform { background-color: #ff8c00 !important; }
        .status-pierside { background-color: #ffff00 !important; }
        .status-pretow { 
            background: repeating-linear-gradient(
                45deg,
                #ffffff,
                #ffffff 3px,
                #00ff00 3px,
                #00ff00 6px
            ) !important;
        }
        .status-operational { background-color: #00ff00 !important; }

        .user-leg .user-indicator {
            background-color: #b19cd9;
        }

        .user-lat .user-indicator {
            background-color: #00bfff;
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 5px 0;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            max-height: 400px;
            overflow-y: auto;
        }

        .context-menu-item {
            padding: 8px 20px;
            cursor: pointer;
            color: #fff;
            font-size: 0.9em;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .context-menu-item:hover {
            background: rgba(0, 191, 255, 0.2);
        }

        .context-menu-submenu {
            position: relative;
        }

        .context-menu-submenu:hover .submenu {
            display: block;
        }

        .submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 8px;
            display: none;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .context-menu-separator {
            height: 1px;
            background: #444;
            margin: 5px 0;
        }

        .status-indicator-menu {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            display: inline-block;
        }

        /* Status Table */
        .status-tracker {
            margin-top: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .status-tracker h2 {
            color: #00bfff;
            margin-bottom: 20px;
            text-align: center;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.3);
        }

        th, td {
            padding: 10px;
            border: 1px solid #444;
            text-align: center;
        }

        th {
            background: rgba(0, 191, 255, 0.2);
            color: #00bfff;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        /* Important: Better contrast for status cells */
        td {
            color: #000 !important;
            font-size: 0.9em;
            line-height: 1.3;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        td small {
            display: block;
            font-size: 0.75em;
            color: #333 !important;
            margin-top: 2px;
            font-weight: normal;
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.5);
        }

        td[data-status] {
            color: #000 !important;
        }

        /* Status cell colors with better contrast */
        td.status-none { 
            background-color: rgba(255, 0, 0, 0.7);
            color: #000 !important;
        }
        td.status-platform { 
            background-color: rgba(255, 140, 0, 0.7);
            color: #000 !important;
        }
        td.status-pierside { 
            background-color: rgba(255, 255, 0, 0.7);
            color: #000 !important;
        }
        td.status-pretow { 
            background: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.7),
                rgba(255, 255, 255, 0.7) 5px,
                rgba(0, 255, 0, 0.7) 5px,
                rgba(0, 255, 0, 0.7) 10px
            );
            color: #000 !important;
        }
        td.status-operational { 
            background-color: rgba(0, 255, 0, 0.7);
            color: #000 !important;
        }

        /* Manual override styles */
        .manual-override-input {
            background: #333;
            border: 1px solid #555;
            color: #fff;
            padding: 3px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            width: 100%;
        }

        .controls {
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .controls input[type="file"] {
            padding: 8px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: #fff;
        }

        .controls button {
            padding: 10px 20px;
            background: linear-gradient(45deg, #00bfff, #b19cd9);
            border: none;
            border-radius: 5px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .controls button:hover {
            transform: scale(1.05);
        }

        .boat-count {
            margin-left: auto;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        @media (max-width: 1200px) {
            .status-boxes {
                flex-direction: column;
                align-items: center;
            }
            
            .status-box {
                max-width: 100%;
                width: 100%;
            }
        }

        /* View-only mode */
        .view-only-indicator {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid orange;
            padding: 10px;
            margin-top: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Boat Status Display System v5</h1>
            <p>Fixed version with proper status tracking and boat movement</p>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-none">
                        <span class="boat-number">C</span>
                    </div>
                </div>
                <span>C Boat</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-none">
                        <span class="boat-number">G</span>
                    </div>
                </div>
                <span>G Boat</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-none"></div>
                </div>
                <span>No Check</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-platform"></div>
                </div>
                <span>Platform Check</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-pierside"></div>
                </div>
                <span>Pierside Check</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-pretow"></div>
                </div>
                <span>Pre-Tow Check</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper">
                    <div class="legend-boat status-operational"></div>
                </div>
                <span>Post-Tow Check</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper user-leg">
                    <div class="legend-boat"></div>
                    <div class="user-indicator">Leg</div>
                </div>
                <span>Leg</span>
            </div>
            <div class="legend-item">
                <div class="legend-boat-wrapper user-lat">
                    <div class="legend-boat"></div>
                    <div class="user-indicator">Lat</div>
                </div>
                <span>Lat</span>
            </div>
            <div class="legend-item">
                <div class="pod" style="position: relative; display: inline-block; padding: 2px;">
                    <div style="width: 10px; height: 20px; background: #666; margin: 1px;"></div>
                    <div style="width: 10px; height: 20px; background: #666; margin: 1px;"></div>
                </div>
                <span>Pod (grouped boats)</span>
            </div>
        </div>

        <!-- Main Display Controls -->
        <div class="display-controls">
            <label>Main Display:</label>
            <select id="mainDisplaySelect">
                <option value="pier">Pier Area</option>
                <option value="tow">Being Towed</option>
                <option value="transit">In Transit</option>
                <option value="operational-area">Operational Area</option>
            </select>
            <button onclick="saveDisplayLayout()">Save Layout</button>
            <button onclick="loadDisplayLayout()">Load Layout</button>
        </div>

        <!-- Main Display Area -->
        <div class="main-display" id="mainDisplay">
            <!-- Boats will be dynamically displayed here -->
        </div>

        <!-- Small Status Boxes -->
        <div class="status-boxes">
            <div class="status-box" data-area="pier">
                <h3>At Pier</h3>
                <div class="status-box-content" id="pierSmallBox"></div>
            </div>
            <div class="status-box" data-area="tow">
                <h3>Being Towed</h3>
                <div class="status-box-content" id="towSmallBox"></div>
            </div>
            <div class="status-box" data-area="transit">
                <h3>In Transit</h3>
                <div class="status-box-content" id="transitSmallBox"></div>
            </div>
            <div class="status-box" data-area="operational-area">
                <h3>Operational Area</h3>
                <div class="status-box-content" id="operationalAreaSmallBox"></div>
            </div>
        </div>

        <div class="controls">
            <input type="file" id="bgImageInput" accept="image/*">
            <button onclick="uploadBackground()">Set Background Image</button>
            <button onclick="saveLayout()">Save All</button>
            <button onclick="loadLayout()">Load All</button>
            <button onclick="exportToCSV()">Export Status Log</button>
            <button onclick="generateViewOnlyLink()">Generate View-Only Link</button>
            <button onclick="window.resetStatusDisplay()" style="background: linear-gradient(45deg, #ff6b6b, #ff5252);">Reset Display</button>
            <div class="boat-count">
                Total Boats: <span id="boatCount">0</span> | 
                Total Pods: <span id="podCount">0</span>
            </div>
        </div>

        <div class="status-tracker">
            <h2>Status Tracking</h2>
            <div class="table-container">
                <table id="statusTable">
                    <thead>
                        <tr>
                            <th>Boat</th>
                            <th>Group</th>
                            <th>No Check</th>
                            <th>Platform</th>
                            <th>Pierside</th>
                            <th>Pre-Tow</th>
                            <th>Post-Tow</th>
                            <th>Being Towed</th>
                            <th>In Transit</th>
                            <th>Op Area</th>
                            <th>Return Pier</th>
                        </tr>
                    </thead>
                    <tbody id="statusTableBody">
                    </tbody>
                </table>
            </div>
            <div class="table-controls">
                <button onclick="exportToCSV()">Export to CSV</button>
                <button onclick="clearStatusTable()">Clear Table</button>
                <div class="google-sheets-info" style="flex: 1; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 5px; margin-left: 20px;">
                    <p style="margin-bottom: 10px; color: #00bfff; font-weight: bold;">Google Sheets Integration:</p>
                    <input type="text" id="webhookUrl" placeholder="Google Sheets webhook URL" style="width: 100%; padding: 8px; margin-bottom: 10px; background: #333; border: 1px solid #555; border-radius: 5px; color: #fff;" />
                    <button onclick="saveWebhookUrl()">Save URL</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu"></div>

<script>
// Global state management - FIXED VERSION
const state = {
    boats: new Map(),
    pods: new Map(),
    currentDisplay: 'pier',
    layouts: new Map(),
    draggedItem: null,
    rotatingBoat: null,
    selectedPod: null,
    isViewOnly: false,
    pollTimer: null,
    // Fixed tracking system
    lastKnownStates: new Map(), // Simple tracking of last known boat states
    statusLogHistory: new Map() // Track what we've already logged
};

// Constants
const N8N_CONFIG = {
    assignmentWebhook: 'https://tacticalleadingedge.app.n8n.cloud/webhook/boat-assignments',
    statusWebhook: 'https://tacticalleadingedge.app.n8n.cloud/webhook/boat-status-update',
    stateWebhook: 'https://tacticalleadingedge.app.n8n.cloud/webhook/boat-state'
};

const POLL_INTERVAL = 30000;
const BOAT_SPACING = {
    horizontal: 13,
    vertical: 15,
    podSpacing: 6.5
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initializeSystem();
});

function initializeSystem() {
    // Check view-only mode
    const urlParams = new URLSearchParams(window.location.search);
    state.isViewOnly = urlParams.get('view') === 'only';
    
    if (state.isViewOnly) {
        enableViewOnlyMode();
    }
    
    // Initialize display
    setupMainDisplay();
    setupContextMenu();
    setupEventListeners();
    
    // Load saved state
    loadSavedState();
    
    // Start polling
    startPolling();
    
    console.log('‚úÖ Boat Status Display v5 Fixed initialized');
}

// Main display management
function setupMainDisplay() {
    const mainDisplay = document.getElementById('mainDisplay');
    const displaySelect = document.getElementById('mainDisplaySelect');
    
    displaySelect.addEventListener('change', function() {
        state.currentDisplay = this.value;
        updateMainDisplay();
    });
    
    // Set up drag and drop for main display
    mainDisplay.addEventListener('dragover', handleDragOver);
    mainDisplay.addEventListener('drop', handleDrop);
    
    // Allow dragging in all displays
    mainDisplay.addEventListener('contextmenu', function(e) {
        if (!state.isViewOnly && !e.target.closest('.boat-wrapper')) {
            e.preventDefault();
            showAreaContextMenu(e, state.currentDisplay);
        }
    });
}

// Update main display based on current selection
function updateMainDisplay() {
    const mainDisplay = document.getElementById('mainDisplay');
    mainDisplay.innerHTML = '';
    
    // Always allow dragging
    mainDisplay.classList.add('draggable-area');
    
    // Update background if pier
    if (state.currentDisplay === 'pier') {
        const savedBg = localStorage.getItem('pierBackground');
        if (savedBg) {
            mainDisplay.style.backgroundImage = savedBg;
        }
    } else {
        mainDisplay.style.backgroundImage = '';
    }
    
    // Load saved layout or default arrangement
    const layout = state.layouts.get(state.currentDisplay);
    if (layout) {
        applyAreaLayout(layout, state.currentDisplay);
    } else {
        arrangeBoatsInArea(state.currentDisplay);
    }
}

// Apply saved layout to any area
function applyAreaLayout(layout, area) {
    const mainDisplay = document.getElementById('mainDisplay');
    
    // Apply boat positions
    if (layout.boats) {
        layout.boats.forEach(savedBoat => {
            const boat = state.boats.get(savedBoat.id);
            if (boat && boat.location === area) {
                boat.x = savedBoat.x;
                boat.y = savedBoat.y;
                boat.rotation = savedBoat.rotation;
                
                boat.element.style.left = savedBoat.x + 'px';
                boat.element.style.top = savedBoat.y + 'px';
                boat.element.style.transform = `rotate(${savedBoat.rotation}deg)`;
                boat.element.classList.remove('in-small-box');
                boat.element.style.position = 'absolute';
                
                mainDisplay.appendChild(boat.element);
            }
        });
    }
    
    // Apply pod positions
    if (layout.pods) {
        layout.pods.forEach(savedPod => {
            const pod = state.pods.get(savedPod.id);
            if (pod && pod.location === area) {
                pod.x = savedPod.x;
                pod.y = savedPod.y;
                pod.rotation = savedPod.rotation;
                
                const podElement = createPodElement(pod);
                podElement.style.left = savedPod.x + 'px';
                podElement.style.top = savedPod.y + 'px';
                
                mainDisplay.appendChild(podElement);
            }
        });
    }
}

// Arrange boats in default pod/boat pattern
function arrangeBoatsInArea(area) {
    const mainDisplay = document.getElementById('mainDisplay');
    const smallBox = document.getElementById(area.replace('-', '') + 'SmallBox');
    
    // Get all boats and pods for this area
    const areaBoats = [];
    const areaPods = [];
    
    state.boats.forEach((boat, id) => {
        if (boat.location === area && !boat.podId) {
            areaBoats.push(boat);
        }
    });
    
    state.pods.forEach((pod, id) => {
        if (pod.location === area) {
            areaPods.push(pod);
        }
    });
    
    // Sort boats by group then number
    areaBoats.sort((a, b) => {
        if (a.userGroup !== b.userGroup) {
            return a.userGroup === 'lat' ? -1 : 1;
        }
        return a.id - b.id;
    });
    
    // Clear displays
    mainDisplay.innerHTML = '';
    if (smallBox) smallBox.innerHTML = '';
    
    // Position pods first, then individual boats
    let currentX = 20;
    let currentY = 20;
    let rowHeight = 0;
    
    // Add pods
    areaPods.forEach(pod => {
        const podElement = createPodElement(pod);
        
        // Check if pod fits in current row
        const podWidth = calculatePodWidth(pod);
        if (currentX + podWidth > mainDisplay.offsetWidth - 40) {
            currentX = 20;
            currentY += rowHeight + BOAT_SPACING.vertical;
            rowHeight = 0;
        }
        
        // Position pod
        if (area === state.currentDisplay) {
            podElement.style.position = 'absolute';
            podElement.style.left = currentX + 'px';
            podElement.style.top = currentY + 'px';
            mainDisplay.appendChild(podElement);
        }
        
        // Add to small box
        if (smallBox) {
            const smallPodElement = createPodElement(pod, true);
            smallBox.appendChild(smallPodElement);
        }
        
        currentX += podWidth + BOAT_SPACING.podSpacing;
        rowHeight = Math.max(rowHeight, calculatePodHeight(pod));
    });
    
    // Add individual boats
    areaBoats.forEach(boat => {
        const boatElement = boat.element;
        
        // Check if boat fits in current row
        const boatWidth = boat.type === 1 ? 34 : 30;
        if (currentX + boatWidth > mainDisplay.offsetWidth - 40) {
            currentX = 20;
            currentY += rowHeight + BOAT_SPACING.vertical;
            rowHeight = 0;
        }
        
        // Position boat in main display
        if (area === state.currentDisplay) {
            boatElement.classList.remove('in-small-box');
            boatElement.style.position = 'absolute';
            boatElement.style.left = currentX + 'px';
            boatElement.style.top = currentY + 'px';
            mainDisplay.appendChild(boatElement);
        }
        
        // Clone for small box
        if (smallBox) {
            const smallBoatElement = boatElement.cloneNode(true);
            smallBoatElement.classList.add('in-small-box');
            smallBoatElement.style.position = 'relative';
            smallBoatElement.style.left = '';
            smallBoatElement.style.top = '';
            smallBoatElement.style.transform = '';
            smallBox.appendChild(smallBoatElement);
        }
        
        currentX += boatWidth + BOAT_SPACING.horizontal;
        rowHeight = Math.max(rowHeight, boat.type === 1 ? 64 : 48);
    });
}

// FIXED: Update from server state - no duplicate logging
async function updateFromServerState() {
    try {
        const response = await fetch(N8N_CONFIG.stateWebhook);
        if (!response.ok) return;
        
        const serverState = await response.json();
        if (!serverState || !serverState.boats) return;
        
        console.log(`Polling update: ${serverState.boats.length} boats from server`);
        
        serverState.boats.forEach(boatData => {
            const existingBoat = state.boats.get(boatData.id);
            
            if (existingBoat) {
                // Update boat data WITHOUT logging to table
                // Just update visual state
                existingBoat.userGroup = boatData.userGroup;
                existingBoat.element.className = `boat-wrapper user-${boatData.userGroup}`;
                existingBoat.element.querySelector('.user-indicator').textContent = 
                    boatData.userGroup === 'leg' ? 'Leg' : 'Lat';
                
                // IMPORTANT: Preserve current check status when boat is in movement area
                const movementStatuses = ['tow', 'transit', 'operational-area'];
                const currentCheckStatus = existingBoat.checkStatus || existingBoat.status;
                
                // Only update status visually, don't log
                if (existingBoat.status !== boatData.status) {
                    // Check if this is a genuine status change from a user
                    const isSystemOperator = ['Initial', 'Assignment System', 'n8n Update', undefined].includes(boatData.operator);
                    
                    if (!isSystemOperator && boatData.operator) {
                        // This is a real user update - check if we should log it
                        const logKey = `${boatData.id}-${boatData.status}-${boatData.operator}-${boatData.lastUpdated}`;
                        
                        if (!state.statusLogHistory.has(logKey)) {
                            // Log this update
                            console.log(`Logging user update: Boat ${boatData.id} to ${boatData.status} by ${boatData.operator}`);
                            addStatusToTable(boatData.id, existingBoat, boatData.status, boatData.operator);
                            state.statusLogHistory.set(logKey, true);
                            
                            // Clean old entries
                            if (state.statusLogHistory.size > 200) {
                                const entries = Array.from(state.statusLogHistory.keys());
                                entries.slice(0, 50).forEach(key => state.statusLogHistory.delete(key));
                            }
                        }
                    }
                    
                    // Update visual status
                    if (movementStatuses.includes(boatData.status)) {
                        // Movement status - keep check status color
                        existingBoat.location = boatData.status === 'operational-area' ? 'operational-area' : boatData.status;
                        existingBoat.boat.className = `boat boat-type-${existingBoat.type} status-${currentCheckStatus}`;
                    } else {
                        // Check status update
                        existingBoat.status = boatData.status;
                        existingBoat.checkStatus = boatData.status;
                        existingBoat.boat.className = `boat boat-type-${existingBoat.type} status-${boatData.status}`;
                    }
                }
                
            } else {
                // Create new boat
                console.log(`Creating new boat ${boatData.id}`);
                createBoat({
                    id: boatData.id,
                    type: boatData.type,
                    userGroup: boatData.userGroup,
                    status: boatData.status,
                    location: boatData.location || 'pier',
                    x: boatData.x || 50 + (state.boats.size % 12) * 50,
                    y: boatData.y || 50 + Math.floor(state.boats.size / 12) * 70,
                    rotation: boatData.rotation || 0
                });
            }
        });
        
        // Update UI state for view-only mode
        if (state.isViewOnly && serverState.uiState) {
            applyUIState(serverState.uiState);
        }
        
        updateBoatCount();
        updateSmallBoxes();
        
    } catch (error) {
        console.error('Error updating from server:', error);
    }
}

// FIXED: Add status to table with better duplicate prevention
function addStatusToTable(boatId, boatData, status, operator, options = {}) {
    // Create unique key for this exact update
    const timestamp = options.timestamp || new Date();
    const timeStr = new Date(timestamp).toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    
    // Check for recent duplicate
    const updateKey = `${boatId}-${status}-${timeStr}`;
    const lastUpdate = state.lastKnownStates.get(updateKey);
    
    if (lastUpdate && (Date.now() - lastUpdate) < 60000) {
        console.log(`Skipping duplicate: ${updateKey}`);
        return;
    }
    
    state.lastKnownStates.set(updateKey, Date.now());
    
    const tbody = document.getElementById('statusTableBody');
    const prefix = boatData.type === 1 ? 'C' : 'G';
    const paddedNumber = boatId.toString().padStart(2, '0');
    const boatName = `${prefix}${paddedNumber}`;
    
    // Map status names
    const statusColumnMap = {
        'none': 'none',
        'platform': 'platform',
        'pierside': 'pierside',
        'pretow': 'pretow',
        'operational': 'operational',
        'tow': 'tow',
        'transit': 'transit',
        'operational-area': 'oparea',
        'return-pier': 'return'
    };
    
    const columnStatus = statusColumnMap[status] || status;
    
    // Find existing rows
    const existingRows = Array.from(tbody.querySelectorAll(`tr[data-boat-id="${boatId}"]`));
    let targetRow = null;
    
    if (existingRows.length === 0) {
        // Create first row
        targetRow = createNewRow(boatId, boatName, boatData);
        tbody.insertBefore(targetRow, tbody.firstChild);
    } else {
        // Check if we need a new row
        let foundEmptyCell = false;
        
        for (const row of existingRows) {
            const statusCell = row.querySelector(`td[data-status="${columnStatus}"]`);
            if (statusCell && statusCell.innerHTML.trim() === '') {
                targetRow = row;
                foundEmptyCell = true;
                break;
            }
        }
        
        if (!foundEmptyCell) {
            // Only create new row for repeated movement statuses
            const movementStatuses = ['tow', 'transit', 'operational-area', 'return-pier'];
            if (movementStatuses.includes(status)) {
                // Check if this is actually a repeat (boat returned and going out again)
                const lastRow = existingRows[existingRows.length - 1];
                const hasReturnedToPier = lastRow.querySelector('td[data-status="return"]').innerHTML.trim() !== '';
                
                if (hasReturnedToPier) {
                    // Boat has completed a cycle, create new row
                    targetRow = createNewRow(boatId, boatName, boatData);
                    lastRow.parentNode.insertBefore(targetRow, lastRow.nextSibling);
                } else {
                    // Still in same cycle, use existing row
                    targetRow = lastRow;
                }
            } else {
                // Check status - don't create new row
                console.log(`Check status ${status} already recorded for boat ${boatId}`);
                return;
            }
        }
    }
    
    // Update the cell
    if (targetRow) {
        const statusCell = targetRow.querySelector(`td[data-status="${columnStatus}"]`);
        if (statusCell) {
            // Get the actual status color
            let displayStatus = status;
            const movementStatuses = ['tow', 'transit', 'operational-area', 'return-pier'];
            if (movementStatuses.includes(status)) {
                // Use the boat's current check status for color
                displayStatus = boatData.checkStatus || boatData.status || 'none';
            }
            
            updateStatusCell(statusCell, displayStatus, operator, timestamp);
            
            console.log(`Status recorded: ${boatName} - ${status} at ${timeStr} by ${operator}`);
            
            // Send to Google Sheets
            sendToGoogleSheets(boatId, boatData, status, operator);
        }
    }
}

// Update status cell
function updateStatusCell(cell, status, operator, timestamp) {
    const ts = timestamp || new Date();
    const timeStr = new Date(ts).toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: false 
    });
    
    cell.className = `status-${status}`;
    cell.innerHTML = `${timeStr}<br><small>${operator}</small>`;
    cell.title = `${new Date(ts).toLocaleString()} - ${operator}`;
    
    // Add context menu for manual override
    cell.addEventListener('contextmenu', function(e) {
        if (!state.isViewOnly) {
            e.preventDefault();
            showCellContextMenu(e, cell, status);
        }
    });
}

// Show context menu for manual cell override
function showCellContextMenu(e, cell, status) {
    const menu = document.getElementById('contextMenu');
    
    menu.innerHTML = `
        <div class="context-menu-item" onclick="manualOverrideCell(this, '${status}')">
            ‚úèÔ∏è Manual Override
        </div>
        <div class="context-menu-item" onclick="clearCell(this)">
            üóëÔ∏è Clear Cell
        </div>
    `;
    
    positionContextMenu(menu, e.pageX, e.pageY);
}

// Position context menu properly
function positionContextMenu(menu, x, y) {
    menu.style.display = 'block';
    
    // Get viewport dimensions
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // Get menu dimensions
    const menuRect = menu.getBoundingClientRect();
    const menuWidth = menuRect.width;
    const menuHeight = menuRect.height;
    
    // Adjust position to keep menu in viewport
    let adjustedX = x;
    let adjustedY = y;
    
    if (x + menuWidth > viewportWidth) {
        adjustedX = viewportWidth - menuWidth - 10;
    }
    
    if (y + menuHeight > viewportHeight) {
        adjustedY = viewportHeight - menuHeight - 10;
    }
    
    // Ensure menu doesn't go off the top or left
    adjustedX = Math.max(10, adjustedX);
    adjustedY = Math.max(10, adjustedY);
    
    menu.style.left = adjustedX + 'px';
    menu.style.top = adjustedY + 'px';
}

// FIXED: Update boat status without duplicate logging
function updateBoatStatus(boatId, newStatus, operator = 'Unknown') {
    const boatData = state.boats.get(boatId);
    if (!boatData) return;
    
    const movementStatuses = ['tow', 'transit', 'operational-area', 'return-pier'];
    const isMovementStatus = movementStatuses.includes(newStatus);
    
    // Save current check status
    if (!isMovementStatus) {
        boatData.checkStatus = newStatus;
    }
    
    // Add to status table
    addStatusToTable(boatId, boatData, newStatus, operator);
    
    if (isMovementStatus) {
        // Movement status - move the boat but keep check status color
        let targetLocation = '';
        if (newStatus === 'tow') targetLocation = 'tow';
        else if (newStatus === 'transit') targetLocation = 'transit';
        else if (newStatus === 'operational-area') targetLocation = 'operational-area';
        else if (newStatus === 'return-pier') targetLocation = 'pier';
        
        if (targetLocation && boatData.location !== targetLocation) {
            // Move boat to new area
            moveBoatToArea(boatId, targetLocation);
            // Keep the check status color
            const checkStatus = boatData.checkStatus || boatData.status;
            boatData.boat.className = `boat boat-type-${boatData.type} status-${checkStatus}`;
        }
    } else {
        // Check status - update color but DON'T move
        boatData.status = newStatus;
        boatData.boat.className = `boat boat-type-${boatData.type} status-${newStatus}`;
    }
    
    // Send update to server
    sendStatusUpdate(boatId, newStatus, operator, boatData.checkStatus);
}

// Move boat to area
function moveBoatToArea(boatId, area) {
    const boatData = state.boats.get(boatId);
    if (!boatData) return;
    
    // Remove from pod if in one
    if (boatData.podId) {
        const pod = state.pods.get(boatData.podId);
        if (pod) {
            pod.boats = pod.boats.filter(id => id !== boatId);
            if (pod.boats.length === 0) {
                state.pods.delete(boatData.podId);
            }
            boatData.podId = null;
        }
    }
    
    // Update location
    boatData.location = area;
    
    // Update displays
    updateMainDisplay();
    updateSmallBoxes();
}

// Create pod element
function createPodElement(pod, isSmallBox = false) {
    const podDiv = document.createElement('div');
    podDiv.className = 'pod';
    podDiv.dataset.podId = pod.id;
    
    if (!isSmallBox && state.currentDisplay === pod.location) {
        podDiv.style.position = 'absolute';
        
        // Make pod draggable in main display
        if (!state.isViewOnly) {
            podDiv.draggable = true;
            podDiv.addEventListener('dragstart', handlePodDragStart);
            podDiv.addEventListener('dragend', handleDragEnd);
            
            // Click to select pod
            podDiv.addEventListener('click', function(e) {
                if (!e.target.closest('.boat-wrapper')) {
                    selectPod(pod.id);
                }
            });
        }
    }
    
    // Add boats to pod
    pod.boats.forEach(boatId => {
        const boat = state.boats.get(boatId);
        if (boat) {
            const boatElement = boat.element.cloneNode(true);
            boatElement.style.position = 'relative';
            boatElement.style.left = '';
            boatElement.style.top = '';
            boatElement.classList.add('in-small-box');
            
            // Sync rotation with pod
            if (pod.rotation) {
                boatElement.style.transform = `rotate(${pod.rotation}deg)`;
            }
            
            podDiv.appendChild(boatElement);
        }
    });
    
    return podDiv;
}

// Pod management functions
function createPod(boatIds, location) {
    const podId = 'pod_' + Date.now();
    const pod = {
        id: podId,
        boats: boatIds,
        location: location,
        rotation: 0,
        x: 0,
        y: 0
    };
    
    state.pods.set(podId, pod);
    
    // Update boats to reference pod
    boatIds.forEach(boatId => {
        const boat = state.boats.get(boatId);
        if (boat) {
            boat.podId = podId;
        }
    });
    
    updatePodCount();
    updateMainDisplay();
    updateSmallBoxes();
    
    return pod;
}

function selectPod(podId) {
    // Deselect previous
    if (state.selectedPod) {
        const prevPod = document.querySelector(`[data-pod-id="${state.selectedPod}"]`);
        if (prevPod) {
            prevPod.classList.remove('selected');
        }
    }
    
    // Select new
    state.selectedPod = podId;
    const podElement = document.querySelector(`[data-pod-id="${podId}"]`);
    if (podElement) {
        podElement.classList.add('selected');
    }
}

// Boat creation
function createBoat(config) {
    const wrapper = document.createElement('div');
    wrapper.className = `boat-wrapper user-${config.userGroup}`;
    wrapper.style.position = 'absolute';
    wrapper.style.left = config.x + 'px';
    wrapper.style.top = config.y + 'px';
    wrapper.style.transform = `rotate(${config.rotation || 0}deg)`;
    wrapper.style.width = config.type === 1 ? '34px' : '30px';
    wrapper.style.height = config.type === 1 ? '64px' : '48px';
    wrapper.id = `boat-wrapper-${config.id}`;
    wrapper.draggable = !state.isViewOnly;
    
    // Create outline
    const outline = document.createElement('div');
    outline.className = 'boat-outline';
    
    const boat = document.createElement('div');
    boat.className = `boat boat-type-${config.type} status-${config.status}`;
    boat.id = `boat-${config.id}`;
    boat.style.position = 'relative';
    boat.style.width = config.type === 1 ? '30px' : '26px';
    boat.style.height = config.type === 1 ? '60px' : '44px';
    boat.style.top = '2px';
    boat.style.left = '2px';
    boat.style.zIndex = '1';
    
    // Add boat number
    const prefix = config.type === 1 ? 'C' : 'G';
    const paddedNumber = config.id.toString().padStart(2, '0');
    
    const boatNumber = document.createElement('span');
    boatNumber.className = 'boat-number';
    boatNumber.textContent = `${prefix}${paddedNumber}`;
    boat.appendChild(boatNumber);
    
    // Create user indicator
    const userIndicator = document.createElement('div');
    userIndicator.className = 'user-indicator';
    userIndicator.textContent = config.userGroup === 'leg' ? 'Leg' : 'Lat';
    userIndicator.style.zIndex = '3';
    
    // Create rotation handle
    const rotationHandle = document.createElement('div');
    rotationHandle.className = 'rotation-handle';
    rotationHandle.style.zIndex = '4';
    rotationHandle.title = 'Click and drag to rotate';
    
    if (state.isViewOnly) {
        rotationHandle.style.display = 'none';
    }
    
    // Assemble elements
    wrapper.appendChild(outline);
    wrapper.appendChild(boat);
    wrapper.appendChild(userIndicator);
    wrapper.appendChild(rotationHandle);
    
    // Add event listeners
    if (!state.isViewOnly) {
        wrapper.addEventListener('dragstart', handleDragStart);
        wrapper.addEventListener('dragend', handleDragEnd);
        
        rotationHandle.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            handleRotationStart(e, wrapper);
        });
        
        wrapper.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            showBoatContextMenu(e, config.id);
        });
    }
    
    // Store boat data
    const boatData = {
        id: config.id,
        element: wrapper,
        boat: boat,
        type: config.type,
        userGroup: config.userGroup,
        status: config.status,
        checkStatus: config.status, // Track check status separately
        location: config.location || 'pier',
        x: config.x,
        y: config.y,
        rotation: config.rotation || 0,
        podId: null
    };
    
    state.boats.set(config.i